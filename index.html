<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">

<!-- A-Frame -->
<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

<!-- AR.js (STABLE VERSION) -->
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

<!-- A-Frame Extras -->
<script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

<style>
body { margin: 0; overflow: hidden; }

.debug-info {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.7);
    color: #fff;
    padding: 8px;
    font-family: monospace;
    z-index: 999;
}

.controls {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    padding: 10px;
    border-radius: 10px;
    display: flex;
    gap: 10px;
    z-index: 999;
}

.btn {
    background: #2ecc71;
    border: none;
    color: white;
    padding: 10px;
    border-radius: 6px;
    font-size: 16px;
}

.hidden { display: none; }
</style>

<script>
let currentScale = 0.25;
let currentRotationY = 0;
let audioPlaying = false;
let audioElement;

// ================= INIT =================
window.addEventListener("DOMContentLoaded", () => {

    // Debug box
    const debug = document.createElement("div");
    debug.className = "debug-info";
    debug.innerText = "Initializing AR...";
    document.body.appendChild(debug);
    window.updateDebug = txt => debug.innerText = txt;

    // Christmas music (FIXED RAW URL)
    audioElement = document.createElement("audio");
    audioElement.src = "https://cdn.jsdelivr.net/gh/NimeshChanuka2000/AR_Project@main/asset/christmas.mp3";
    audioElement.loop = true;
    document.body.appendChild(audioElement);

    // Controls
    const controls = document.createElement("div");
    controls.className = "controls hidden";
    controls.id = "controls";

    controls.innerHTML = `
        <button class="btn" onclick="rotateModel(-30)">â†º</button>
        <button class="btn" onclick="rotateModel(30)">â†»</button>
        <button class="btn" onclick="scaleModel(0.05)">+</button>
        <button class="btn" onclick="scaleModel(-0.05)">âˆ’</button>
        <button class="btn" onclick="toggleSound()">ðŸŽµ</button>
    `;
    document.body.appendChild(controls);

    updateDebug("Waiting for marker...");
});

// ================= CONTROLS =================
function rotateModel(val) {
    const tree = document.querySelector("#treeModel");
    if (!tree) return;
    currentRotationY += val;
    tree.setAttribute("rotation", `0 ${currentRotationY} 0`);
}

function scaleModel(val) {
    const tree = document.querySelector("#treeModel");
    if (!tree) return;
    currentScale = Math.max(0.1, currentScale + val);
    tree.setAttribute("scale", `${currentScale} ${currentScale} ${currentScale}`);
}

function toggleSound() {
    if (!audioElement) return;
    if (audioPlaying) {
        audioElement.pause();
        audioPlaying = false;
        updateDebug("Music paused");
    } else {
        audioElement.play();
        audioPlaying = true;
        updateDebug("Music playing ðŸŽ„");
    }
}

// ================= MATERIAL FIX =================
AFRAME.registerComponent("tree-material-fix", {
    init() {
        this.el.addEventListener("model-loaded", () => {
            const model = this.el.getObject3D("mesh");
            model.traverse(n => {
                if (n.isMesh && n.material) {
                    n.material.metalness = 0;
                    n.material.roughness = 0.7;
                    if (n.material.map) {
                        n.material.map.encoding = THREE.sRGBEncoding;
                        n.material.map.needsUpdate = true;
                    }
                }
            });
            updateDebug("Tree loaded ðŸŽ„");
        });

        this.el.addEventListener("model-error", e => {
            updateDebug("Model error: " + e.detail);
        });
    }
});

// ================= MARKER EVENTS =================
AFRAME.registerComponent("marker-handler", {
    init() {
        const panel = document.getElementById("controls");
        this.el.addEventListener("markerFound", () => {
            panel.classList.remove("hidden");
            updateDebug("Marker detected");
        });
        this.el.addEventListener("markerLost", () => {
            panel.classList.add("hidden");
            updateDebug("Marker lost");
        });
    }
});
</script>
</head>

<body>

<a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="colorManagement: true; physicallyCorrectLights: true">

    <a-marker
        type="pattern"
        url="https://cdn.jsdelivr.net/gh/NimeshChanuka2000/AR_Project@main/asset/pattern-marker.patt"
        marker-handler>

        <!-- Lighting -->
        <a-entity light="type: ambient; intensity: 0.8"></a-entity>
        <a-entity light="type: directional; intensity: 1.2" position="1 2 1"></a-entity>

        <!-- CHRISTMAS TREE MODEL -->
        <a-entity
            id="treeModel"
            position="0 0 0"
            rotation="0 0 0"
            scale="0.25 0.25 0.25"
            gltf-model="https://cdn.jsdelivr.net/gh/NimeshChanuka2000/AR_Project@main/asset/xmas.glb"
            tree-material-fix>
        </a-entity>

    </a-marker>

    <a-entity camera></a-entity>
</a-scene>

</body>
</html>

